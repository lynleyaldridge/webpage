---
title: "Tables in R Markdown: Summarizing data using gt"
author: Lynley Aldridge
date: '2021-01-26'
slug: tables-in-r-markdown-using-gt
categories: []
tags:
  - Tutorial
  - Rstats
draft: TRUE
subtitle: ''
summary: ''
authors: []
lastmod: '2021-01-26T19:04:10+11:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

## Setup

As in the previous post, load packages, read in data, and clean and extract data using the following syntax:

```{r setup, message = FALSE}

#load packages
library(tidyverse)
library(odbc)
library(DBI)
library(RSQLite)
# library(arsenal) # for summary tables
library(gt) # for summary tables
library(tidytext) # for reorder_within

library(ggflags) 

#to install ggflags, I needed to install devtools then type into console: devtools::install_github('rensa/ggflags'); this uses circular flags but renders an error if country code not a match (e.g., for worldwide row)

#library(countrycode)
#library(ggimage)

#currently not loading ggimage as it may clash with flags

# library(reactable) # not available for this version of R


#load data
sales <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-29/sales.csv')
charts <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-29/charts.csv')

#create connection to database and copy data into database
con <- dbConnect(RSQLite::SQLite(), ":memory:")
copy_to(con, sales)
copy_to(con, charts)

#clean release dates as per previous post
dbExecute(con, "
UPDATE charts
SET released = TRIM(SUBSTR(released, 1, INSTR(released, ' (')))
WHERE INSTR(released, ' (')>0; 
                          ")

```

```{sql, connection = con, output.var = "df"}

SELECT charts.artist, charts.title, SUBSTR(charts.released, -4) AS released, 
  US_charts.chart_position AS US_position,
  UK_charts.chart_position AS UK_position,
  round(US_sales.sales/1000000, 1) AS US_sales, 
  round(UK_sales.sales/1000000, 1) AS UK_sales, 
  round(WW_sales.sales/1000000, 1) AS WW_sales, 
  round((WW_sales.sales - US_sales.sales - UK_sales.sales)/1000000, 1) AS other_sales,
  round(US_sales.sales/WW_sales.sales*100, 1) AS US_percent,
  round(UK_sales.sales/WW_sales.sales*100, 1) AS UK_percent,
  round((WW_sales.sales - US_sales.sales - UK_sales.sales)/WW_sales.sales*100, 1) AS other_percent
FROM charts
LEFT JOIN (SELECT artist, title, chart_position FROM charts WHERE chart = "US") AS US_charts
ON charts.title = US_charts.title
LEFT JOIN (SELECT artist, title, chart_position FROM charts WHERE chart = "UK") AS UK_charts
ON charts.title = UK_charts.title
LEFT JOIN sales
ON charts.chart = sales.country and charts.title = sales.title
LEFT JOIN (SELECT artist, title, sales FROM sales WHERE country = "US") AS US_sales
  ON sales.title = US_sales.title
LEFT JOIN (SELECT artist, title, sales FROM sales WHERE country = "UK") AS UK_sales
  ON sales.title = UK_sales.title
LEFT JOIN (SELECT artist, title, sales FROM sales WHERE country = "WW" OR country = "World") AS WW_sales
  ON sales.title = WW_sales.title
GROUP BY charts.artist, charts.title
ORDER BY charts.artist DESC, released ASC;
```

## Formatting tables nicely in R Markdown

How would we go about making a nice table for R Markdown reports. Lots of packages to try, arsenal, flextable, gt ... 

Reviews and demonstrations of multiple packages available for producing tables in R can be found at:

* David Keyes' summary of [How to make beautiful tables in R](https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/) offers short reviews and demonstrations of gt, kable and kableExtra, formattable, DT, reactable, flextable, huxtable, rhandsontable, and pixiedust

* Pascal Schmidt's [How to easily create descriptive summary statistics tables in R studio - By group](https://thatdatatho.com/2018/08/20/easily-create-descriptive-summary-statistic-tables-r-studio/) reviews and demonstrates packages that are particularly useful for summary statistics tables that compare groups, including two of my favorites so far for this purpose, arsenal and tableone

and ways to create highly customized and attractive summary tables include:


GT documentation:
https://blog.rstudio.com/2020/04/08/great-looking-tables-gt-0-2/


add percent_US bars for sales (look at rule 10 in Thomas Mock blog?

https://themockup.blog/posts/2020-09-04-10-table-rules-in-r/

https://themockup.blog/posts/2020-10-31-embedding-custom-features-in-gt-tables/

Okay, if you want to analyse sales by album, here's some industry-speak:

https://chartmasters.org/2020/10/taylor-swift-albums-and-songs-sales/

Obviously global sales totals for later albums will be less?

Over 70% of sales from US - abroad improved with success of 1989 

Reputation came out after streaming was inevitable and naturally sold less but high by today's standards ... 

```{r}
df %>%
  
    filter(artist == "Taylor Swift") %>%
    
    mutate( 
    # combine values from two columns into a single column
    title_artist = paste0("<span style='color:#344072'>**", 
                title, "**</span>", "<br><span     style='color:#8086A0'>", artist, "</span>"), 
 
    # add a column containing urls to album art
    img = paste0("https://raw.githubusercontent.com/gkaramanis/tidytuesday/master/2020-week40/img/", 
                title, ".jpg")) %>%

    # arrange by release date
    arrange(released) %>% 
    
    select(img, title_artist, released, US_position, UK_position, WW_sales, US_sales,
           US_percent) %>%
  
  # create a table using gt
  gt() %>%
  
    # set column labels 
    cols_label(
      img = "",
      title_artist = html("<div style='text-align:left;
                          '>Album<br><span style='color:#8086A0'>Artist</span></div>"),
      released = "Released",
      US_position = "US",
      UK_position = "UK",
      US_sales = "US",
      # UK_sales = "UK",
      WW_sales = "World",
      # other_sales = "Other",
      US_percent = "US") %>%
      # UK_percent = "UK",
      # other_percent = "Other") %>%
  
    # transform text in img column to display and appropriately size images
    text_transform(
      locations = cells_body(vars(img)),
      fn = function(x){
      web_image(url = x, height = 80)
      }
    ) %>%
  
    # size columns
    cols_width(
    vars(title_artist) ~ px(150),
    vars(released) ~ px(80),
    vars(US_position) ~ px(35),
    vars(UK_position) ~ px(35),
    vars(WW_sales) ~ px(50),
    vars(US_sales) ~ px(50),
    vars(US_percent) ~ px(50)
    ) %>%
  
    # transform NA values in all columns to "-"
    text_transform(
      locations = cells_body(columns = gt::everything()),
      fn = function(x) {
      str_replace(x, "NA", "–")
      }
    ) %>%
  
    # format title_artist column as markdown text
    fmt_markdown(columns = c("title_artist")) %>%

    # align cells containing numeric values right
    cols_align(align = "right", columns = c("US_position", "UK_position", "WW_sales",
                                            "US_sales", "US_percent")) %>%
  
    # create headings spanning multiple columns
    tab_spanner(label = "Chart position", columns = vars(US_position, UK_position)) %>%
    tab_spanner(label = "Sales (millions)", columns = vars(WW_sales, US_sales)) %>%
    tab_spanner(label = "Sales (percent)", columns = vars(US_percent)) %>%
  
    # create title for table
    tab_header(
      title = md("Lover was Taylor Swift's album with the broadest global appeal, while Speak Now sold primarily to US audiences")) %>%
  
    # create source note for table
    tab_source_note("Source: Billboard, Table: Modified from Georgios Karamanis") %>%
  
    # change column labels to uppercase
    tab_options(
      column_labels.text_transform = "uppercase",
      table.font.color = "#344072"
    )

```

# A simpler table example

Add average rows for each artist, 


```{r}
df %>%
  
  # create a table using gt, grouping by artist and using title_artist for column names
  gt(rowname_col = "title", groupname_col = "artist") %>%
  
    # set column labels 
    cols_label(
      US_position = "US",
      UK_position = "UK",
      US_sales = "US",
      # UK_sales = "UK",
      WW_sales = "Worldwide",
      # other_sales = "Other",
      US_percent = "US") %>%
      # UK_percent = "UK",
      # other_percent = "Other") %>%
  
   # transform NA values in all columns to "-"
    text_transform(
      locations = cells_body(columns = gt::everything()),
      fn = function(x) {
      str_replace(x, "NA", "–")
      }
    ) %>%
  
    # create headings spanning multiple columns
    tab_spanner(label = "Chart position", columns = vars(US_position, UK_position)) %>%
    tab_spanner(label = "Sales (millions)", columns = vars(WW_sales, US_sales)) %>%
    tab_spanner(label = "Sales (percent)", columns = vars(US_percent)) %>%
  
    # create title for table
    tab_header(
      title = md("Taylor Swift and Beyoncé"))

```
